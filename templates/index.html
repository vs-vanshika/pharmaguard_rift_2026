<!DOCTYPE html>
<html>
<head>
    <title>PharmaGuard AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
            margin: 0;
            padding: 0;
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 50px auto;
            background: rgba(255,255,255,0.08);
            padding: 30px;
            border-radius: 16px;
            backdrop-filter: blur(15px);
        }

        h1 { text-align:center; }

        .drop-zone {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            margin-top: 20px;
            cursor: pointer;
            transition: 0.3s;
        }

        input[type="text"] {
            width:100%;
            padding:12px;
            border-radius:8px;
            border:none;
            margin-top:15px;
        }

        button {
            width:100%;
            padding:12px;
            margin-top:15px;
            border-radius:8px;
            border:none;
            background:#00c6ff;
            color:white;
            font-weight:bold;
            cursor:pointer;
        }

        button:hover {
            background:#0072ff;
        }

        .card {
            background:white;
            color:black;
            padding:20px;
            margin-top:20px;
            border-radius:12px;
            box-shadow:0 5px 15px rgba(0,0,0,0.1);
        }

        .badge {
            padding:6px 12px;
            border-radius:20px;
            color:white;
            font-weight:bold;
        }

        .safe { background:#2ecc71; }
        .adjust { background:#f1c40f; }
        .toxic { background:#e74c3c; }

        .loader {
            border:5px solid #f3f3f3;
            border-top:5px solid #3498db;
            border-radius:50%;
            width:40px;
            height:40px;
            animation: spin 1s linear infinite;
            margin:20px auto;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .error { color:#ff6b6b; margin-top:10px; }

    </style>
</head>

<body>

<div class="container">

    <h1>PharmaGuard AI</h1>

    <!-- Drag & Drop -->
    <div class="drop-zone" id="dropZone">
        <span id="fileLabel">
            Drag & Drop VCF file here or click to upload
        </span>
        <div id="fileInfo" style="margin-top:8px; font-size:14px; opacity:0.8;"></div>
        <input type="file" id="fileInput" accept=".vcf" hidden>
    </div>

    <!-- Drug Input -->
    <input type="text" id="drugInput"
           placeholder="Enter drugs (comma-separated): CODEINE,WARFARIN">

    <button onclick="submitForm()">Analyze</button>

    <div id="errorMsg" class="error"></div>
    <div id="loader" style="display:none;" class="loader"></div>
    <div id="results"></div>

</div>

<script>

let selectedFile = null;
let globalResults = [];

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const fileLabel = document.getElementById("fileLabel");
const fileInfo = document.getElementById("fileInfo");
const errorMsg = document.getElementById("errorMsg");

// Click upload
dropZone.addEventListener("click", () => {
    fileInput.click();
});

// Drag over
dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.borderColor = "#00ffcc";
    dropZone.style.background = "rgba(0,255,204,0.08)";
});

// Drag leave
dropZone.addEventListener("dragleave", () => {
    dropZone.style.borderColor = "#ccc";
    dropZone.style.background = "transparent";
});

// Drop file
dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.style.borderColor = "#2ecc71";
    dropZone.style.background = "rgba(46,204,113,0.08)";

    const file = e.dataTransfer.files[0];
    if (file) {
        selectedFile = file;
        validateAndDisplayFile(file);
    }
});

// Normal selection
fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (file) {
        selectedFile = file;
        validateAndDisplayFile(file);
    }
});

function validateAndDisplayFile(file) {

    if (!file.name.endsWith(".vcf")) {
        fileLabel.innerHTML = "❌ Only .vcf files allowed";
        fileInfo.innerHTML = "";
        dropZone.style.borderColor = "#e74c3c";
        selectedFile = null;
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        fileLabel.innerHTML = "❌ File exceeds 5MB limit";
        fileInfo.innerHTML = "";
        dropZone.style.borderColor = "#e74c3c";
        selectedFile = null;
        return;
    }

    fileLabel.innerHTML = "✔ " + file.name;
    fileInfo.innerHTML = "Size: " + (file.size / (1024 * 1024)).toFixed(2) + " MB";
    dropZone.style.borderColor = "#2ecc71";
}

async function submitForm() {

    errorMsg.textContent = "";
    document.getElementById("results").innerHTML = "";
    document.getElementById("loader").style.display = "block";

    const drugs = document.getElementById("drugInput").value.trim();

    if (!selectedFile || !drugs) {
        errorMsg.textContent = "Upload file and enter drug(s).";
        document.getElementById("loader").style.display = "none";
        return;
    }

    const formData = new FormData();
    formData.append("file", selectedFile);
    formData.append("drug", drugs);

    try {
        const response = await fetch("/analyze", {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            const err = await response.json();
            errorMsg.textContent = err.detail;
            document.getElementById("loader").style.display = "none";
            return;
        }

        const data = await response.json();
        renderResults(data);

    } catch (error) {
        errorMsg.textContent = "Server error. Try again.";
    }

    document.getElementById("loader").style.display = "none";
}

function renderResults(data) {

    globalResults = data;
    const container = document.getElementById("results");
    container.innerHTML = "";

    data.forEach((result, index) => {

        let badgeClass = "safe";
        if (result.risk_assessment.risk_label === "Adjust Dosage") badgeClass = "adjust";
        if (result.risk_assessment.risk_label === "Toxic") badgeClass = "toxic";

        container.innerHTML += `
            <div class="card">
                <h3>${result.drug}</h3>
                <span class="badge ${badgeClass}">
                    ${result.risk_assessment.risk_label}
                </span>
                <p><strong>Severity:</strong> ${result.risk_assessment.severity}</p>

                <details>
                    <summary>Pharmacogenomic Profile</summary>
                    <pre>${JSON.stringify(result.pharmacogenomic_profile, null, 2)}</pre>
                </details>

                <details>
                    <summary>Clinical Recommendation</summary>
                    <p>${result.clinical_recommendation.recommended_action}</p>
                </details>

                <details>
                    <summary>AI Explanation</summary>
                    <p>${result.llm_generated_explanation.summary}</p>
                </details>

                <button onclick="copyJSON(${index})">Copy JSON</button>
                <button onclick="downloadJSON(${index})">Download JSON</button>
            </div>
        `;
    });
}

function copyJSON(index) {
    const data = globalResults[index];
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    alert("JSON copied!");
}

function downloadJSON(index) {
    const data = globalResults[index];

    const blob = new Blob(
        [JSON.stringify(data, null, 2)],
        { type: "application/json" }
    );

    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = data.drug + "_report.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
}

</script>

</body>
</html>
